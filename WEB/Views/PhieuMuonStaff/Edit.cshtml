@model WEB.Models.Response.PhieuMuon

@{
    ViewData["Title"] = "Sửa Phiếu Mượn";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var chiTietPhieuMuons = ViewBag.ChiTietPhieuMuons as List<WEB.Models.Response.ChiTietPhieuMuon>;
}

<div class="container-fluid my-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-4">Sửa Phiếu Mượn #@Model.MaPhieuMuon</h5>

            <form method="post" asp-action="Edit" asp-controller="PhieuMuonStaff" asp-route-maPM="@Model.MaPhieuMuon">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div id="chiTietContainer">
                    @for (int i = 0; i < chiTietPhieuMuons.Count; i++)
                    {
                        var chiTiet = chiTietPhieuMuons[i];
                        <div class="chi-tiet-item border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Thiết Bị</label>
                                        <select name="ChiTietPhieuMuons[@i].MaTB" class="form-select" required>
                                            <option value="">-- Chọn thiết bị --</option>
                                            @foreach (var tb in ViewBag.ThietBis)
                                            {
                                                <option value="@tb.MaThietBi" selected="@(tb.MaThietBi == chiTiet.MaTB)">
                                                    @tb.TenThietBi (@tb.SoLuongCon có sẵn)
                                                </option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Số Lượng Mượn</label>
                                        <input type="number" name="ChiTietPhieuMuons[@i].SoLuongTBMuon" class="form-control" required min="1" value="@chiTiet.SoLuongTBMuon" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Ngày Mượn</label>
                                        <input type="date" name="ChiTietPhieuMuons[@i].NgayMuon" class="form-control" required value="@chiTiet.NgayMuon.ToString("yyyy-MM-dd")" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Ngày Dự Kiến Trả</label>
                                        <input type="date" name="ChiTietPhieuMuons[@i].NgayDuKienTra" class="form-control" required value="@chiTiet.NgayDuKienTra.ToString("yyyy-MM-dd")" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Mục Đích</label>
                                        <textarea name="ChiTietPhieuMuons[@i].MucDich" class="form-control" required rows="2">@chiTiet.MucDich</textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check mb-3">
                                        <input type="checkbox" name="ChiTietPhieuMuons[@i].TinhCanThiet" class="form-check-input" value="true" checked="@chiTiet.TinhCanThiet" />
                                        <label class="form-check-label">Tình trạng khẩn cấp</label>
                                    </div>
                                </div>
                            </div>

                            @if (i > 0)
                            {
                                <button type="button" class="btn btn-danger btn-sm mt-2 remove-item">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            }
                        </div>
                    }
                </div>

                <div class="mb-3">
                    <button type="button" id="themChiTiet" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> Thêm Thiết Bị
                    </button>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Lưu Thay Đổi</button>
                    <a href="@Url.Action("Index", "PhieuMuonStaff")" class="btn btn-secondary">Quay Lại</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function () {
            let chiTietCount = @chiTietPhieuMuons.Count;

            // Form submission handling
            $('form').on('submit', function (e) {
                e.preventDefault();

                if ($(this).valid()) {
                    const formData = new FormData(this);
                    const jsonData = {};
                    
                    // Convert FormData to JSON object
                    formData.forEach((value, key) => {
                        // Handle array notation in form field names
                        if (key.includes('[')) {
                            const mainKey = key.split('[')[0];
                            const subKey = key.split('[')[1].split(']')[0];
                            if (!jsonData[mainKey]) {
                                jsonData[mainKey] = [];
                            }
                            if (!jsonData[mainKey][subKey]) {
                                jsonData[mainKey][subKey] = {};
                            }
                            const fieldName = key.split('.')[1];
                            jsonData[mainKey][subKey][fieldName] = value;
                        } else {
                            jsonData[key] = value;
                        }
                    });

                    // Hiển thị loading
                    const submitBtn = $(this).find('button[type="submit"]');
                    const originalText = submitBtn.html();
                    submitBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...');
                    submitBtn.prop('disabled', true);

                    // Gửi request bằng AJAX với method PUT
                    $.ajax({
                        url: $(this).attr('action'),
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(jsonData),
                        success: function (response) {
                            if (response.success) {
                                // Hiển thị thông báo thành công
                                alert('Cập nhật phiếu mượn thành công!');
                                // Chuyển hướng về trang Index
                                window.location.href = '@Url.Action("Index", "PhieuMuonStaff")';
                            } else {
                                alert(response.message || 'Có lỗi xảy ra khi cập nhật phiếu mượn.');
                                submitBtn.html(originalText);
                                submitBtn.prop('disabled', false);
                            }
                        },
                        error: function (xhr, status, error) {
                            // Hiển thị thông báo lỗi
                            let errorMessage = 'Có lỗi xảy ra khi cập nhật phiếu mượn.';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            }
                            alert(errorMessage);

                            // Reset button
                            submitBtn.html(originalText);
                            submitBtn.prop('disabled', false);
                        }
                    });
                }
            });

            // Xử lý xóa chi tiết
            $(document).on('click', '.remove-item', function() {
                $(this).closest('.chi-tiet-item').remove();
                updateIndexes();
            });

            $('#themChiTiet').click(function () {
                const template = $('.chi-tiet-item').first().clone();
                
                // Cập nhật các name attribute với index mới
                template.find('select, input, textarea').each(function () {
                    const name = $(this).attr('name');
                    if (name) {
                        $(this).attr('name', name.replace('[0]', `[${chiTietCount}]`));
                    }
                });

                // Reset giá trị
                template.find('select').val('');
                template.find('input[type="number"]').val('');
                template.find('input[type="date"]').val('');
                template.find('textarea').val('');
                template.find('input[type="checkbox"]').prop('checked', false);

                // Thêm nút xóa
                const deleteBtn = $('<button type="button" class="btn btn-danger btn-sm mt-2 remove-item"><i class="fas fa-trash"></i> Xóa</button>');
                template.append(deleteBtn);

                $('#chiTietContainer').append(template);
                chiTietCount++;

                // Re-parse validation on new elements
                $.validator.unobtrusive.parse(template);
            });

            function updateIndexes() {
                $('.chi-tiet-item').each(function(index) {
                    $(this).find('select, input, textarea').each(function() {
                        const name = $(this).attr('name');
                        if (name) {
                            $(this).attr('name', name.replace(/\[\d+\]/, `[${index}]`));
                        }
                    });
                });
            }
        });
    </script>
} 